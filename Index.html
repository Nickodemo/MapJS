<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<head>
	<title>Map Template for land use</title>
	
    <link rel="icon" href="res/maps.ico">
	<script src="lib/jquery.min.js"></script>
	<!-- Bootstrap core -->
	<script src="lib/bootstrap.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet">    
    <!-- Custom styles for this template -->
    <link href="css/cover.css" rel="stylesheet">   
	<!--Libreria Leaflet-->
	<link rel="stylesheet" href="css/leaflet.css" />
	<script src="lib/leaflet.js"></script>
	
	<!--Sincronización del mapa-->	
	<script src="lib/leaflet.mouseCoordinate.js"></script>
	<link rel="stylesheet" href="css/leaflet.mouseCoordinate.css"/>
	<!--Sincronización del mapa-->	
	<script src="lib/L.Map.Sync.js"></script>
	<!--Impresion mapa-->
	<link rel="stylesheet" href="css/easyPrint.css"/>
    <script src="lib/leaflet.easyPrint.js"></script>
	<!--Mapa situacion-->
	<link rel="stylesheet" href="css/Control.MiniMap.css" />
	<script src="lib/Control.MiniMap.js"></script>		
	<!--Turf.js-->
	<script src="lib/turf.min.js"></script>		
	<!--Custom functions-->	
	<script src="lib/functions.js"></script>
	<!--Draw-->
	<link rel="stylesheet" href="css/leaflet.draw.css">
	<script src="lib/leaflet.draw.js"></script>
	<!--<script src="lib/leaflet-pip.min.js"></script>-->
	<script src="http://cdn-geoweb.s3.amazonaws.com/terraformer/1.0.4/terraformer.min.js"></script>
	<!--Capa 1987-->		
	<script src="source/Usos_suelo_1987.js"></script>
	<script src="source/Salinas_1987.js"></script>
	
	
	<style>
		
		a{
			cursor: pointer;
		}
		
		.simple_view {			
			text-shadow:none;
			text-align:left;
			width:100%;
		}
		
		.left_map1987 {
			float: left;
			width:49%;
		}
	
		.right_map2014 {
			float: right;
			width:49%;
		}

		.mapa_sync{		
			height: 750px;
			text-shadow:none;
			text-align:left;
			/*box-shadow: 5px 5px 5px #888;*/
		}
		.leaflet-popup-content {
			color: grey;
			text-shadow: none;
		}
		.body{
			text-shadow: none !important;
		}
		.leaflet-control-mouseCoordinate.leaflet-control {
			width: 166px;
		}
		
	</style>
</head>

<body>
	<div class="site-wrapper">
	  <div class="site-wrapper-inner">
		<div class="cover-container">
		  <div class="masthead clearfix">
			<div class="inner">
				<h3 class="masthead-brand">Cobertura del suelo en el Poniente Almeriense</h3>
			  <nav>
				<ul class="nav masthead-nav">
				  <li id="tab_home" class="active"><a onclick="views_type('home');">Home</a></li>				  
				  <li id="tab_1987"><a onclick="views_type('map1987');">Mapa 1987</a></li>
				  
				</ul>
			  </nav>
			</div>
		  </div>
		  
			<div id= 'home'class="inner cover" style="display: none;">
				
				<div class="container ">
					<div class="row">
						<div class="col-xs-3 col-md-4">
							<a onclick="views_type('map1987');" class="thumbnail"><img src="res/screenshoot1.png" alt="..."></a>
						</div>
											
					</div>
				</div>
				<h1 class="cover-heading">Cover your page.</h1>				
			</div>
			<div id='double_view' class="inner cover">			
				<div id='map1987' class="mapa_sync"></div>
			</div>
			
		  <div class="mastfoot">
			<div class="inner">
			  <p>Map Template for <a href="#">Project</a>, by <a href="https://github.com/virulilla">Elena Salido 2016</a></p>
			</div>
		  </div>
		</div>
	  </div>
	</div>
	<script>
				
	var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org"> OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="http://mapbox.com">Mapbox</a>',
		mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';

	//Añadimos mapa base como tileLayer
	var OSM1987 = L.tileLayer(mbUrl, { attribution: mbAttr, id: 'mapbox.light', maxZoom: 18 });		
	
	//Creo la capa en leaflet
	var layer_usos1987=new L.geoJson(Usos_suelo_1987,{style:style});
	
	//Creo capa de terraformer
	var terra_salinas1987=new Terraformer.Primitive(Salinas_1987);
	var pruebaFeature=new Terraformer.Primitive(Salinas_1987.features[0]);
	
	//Constructor mapa
	var map1987= L.map('map1987', { center: [36.76,-2.67], zoom: 10, attributionControl: false, layers: [layer_usos1987], onEachFeature: onEachFeature });
		
	//Geoprocesos con Turf.js----------------------------------------	
	// Initialise the FeatureGroup to store editable layers
	var drawnItems1987 = new L.FeatureGroup();

	map1987.addLayer(drawnItems1987);


	// Initialise the draw control and pass it the FeatureGroup of editable layers
	var drawControl1987 = new L.Control.Draw({
		draw: {
			position: 'topleft',
			polygon: {
				title: 'Draw a sexy polygon!',
				allowIntersection: false,
				drawError: {
					color: '#b00b00',
					timeout: 1000
				},
				shapeOptions: {
					color: '#bada55'
				},
				showArea: true
			},
			polyline: {
				metric: false
			},
			circle: {
				shapeOptions: {
					color: '#662d91'
				}
			}
		},
		edit: {
			featureGroup: drawnItems1987
		}
	});
	
		
	map1987.addControl(drawControl1987);
	
	
	//Triggered when a new vector or marker has been created
	map1987.on('draw:created', function (e) {
		var type = e.layerType,//layerType es el tipo de objeto. En este caso puede ser: poligon, rectangulo, círculo o marker.
			layer = e.layer; //'e' es el objecto que dispara la función. En este caso es un poligono de Draw

		if (type === 'marker') {
			//var results = leafletPip.pointInLayer([layer._latlng.lng, layer._latlng.lat], Usos_suelo_1987.features);
			//	area= turf.area(results);
			//	uso_suelo = "ToBeDefine";
				
			
			//layer.bindPopup('A popup!');
		}else if (type === 'rectangle'||type === 'polygon'){
			var coleccion_salinas = new L.FeatureGroup();
			var polygon_aux=new L.Polygon(layer._latlngs, layer.options ).toGeoJSON();
			var area_salinas=0;
			
			for( i=0; i<Salinas_1987.features.length; i++ ){
				var interseccion = turf.intersect(polygon_aux.geometry, Salinas_1987.features[i].geometry);
				console.log(interseccion);
				if(interseccion !== undefined){
					console.log('Existe interseccion con el elemento ' + i + ' con superficie: ' + turf.area(Salinas_1987.features[i]));
					coleccion_salinas.addLayer(interseccion);
					area_salinas=area_salinas+turf.area(interseccion);
				}			
			}
			console.log('La superficie de las salinas es '+ area_salinas+'m2');			
			
		}

		drawnItems1987.addLayer(layer);
	});
		

	</script>
</body>
	
</html>