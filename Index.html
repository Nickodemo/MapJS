<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<head>
	<title>Map Template for land use</title>
	
    <link rel="icon" href="res/maps.ico">
	<!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">    
    <!-- Custom styles for this template -->
    <link href="css/cover.css" rel="stylesheet">   
	<!--Libreria Leaflet-->
	<link rel="stylesheet" href="css/leaflet.css" />
	<script src="lib/leaflet.js"></script>
	
	<!--Sincronización del mapa-->	
	<script src="lib/leaflet.mouseCoordinate.js"></script>
	<link rel="stylesheet" href="css/leaflet.mouseCoordinate.css"/>
	<!--Sincronización del mapa-->	
	<script src="lib/L.Map.Sync.js"></script>
	<!--Impresion mapa-->
	<link rel="stylesheet" href="css/easyPrint.css"/>
    <script src="lib/leaflet.easyPrint.js"></script>
	<!--Mapa situacion-->
	<link rel="stylesheet" href="css/Control.MiniMap.css" />
	<script src="lib/Control.MiniMap.js"></script>		
	<!--Turf.js-->
	<script src="lib/turf.min.js"></script>
	<!--Custom functions-->	
	<script src="lib/functions.js"></script>
	<!--Draw-->
	<link rel="stylesheet" href="css/leaflet.draw.css">
	<script src="lib/leaflet.draw.js"></script>
	<!--CircleYoPolygon-->
	<script src="lib/LeafletCircleToPolygon.js"></script>
	<!--L.Polyline.measuredDistance.js-->
	<script src="lib/L.Polyline.measuredDistance.js"></script>
	<!--Webix-->
	<script src="lib/webix.js" type="text/javascript"></script>
	<link rel="STYLESHEET" type="text/css" href="css/webix.css">
	<!--Capas 2014 y 1987
	<script src="source/Escasa_nula_vegetacion_2014.js"></script>
	<script src="source/Arbolado_forestal_2014.js"></script>
	<script src="source/Cultivos_forzados_2014.js"></script>
	<script src="source/Frutal_2014.js"></script>
	<script src="source/Huerta_2014.js"></script>
	<script src="source/Masas_agua_2014.js"></script>
	<script src="source/Pastizal_2014.js"></script>
	<script src="source/Salinas_2014.js"></script>	
	<script src="source/Escasa_nula_vegetacion_1987.js"></script>
	<script src="source/Arbolado_forestal_1987.js"></script>
	<script src="source/Cultivos_forzados_1987.js"></script>
	<script src="source/Frutal_1987.js"></script>
	<script src="source/Huerta_1987.js"></script>
	<script src="source/Masas_agua_1987.js"></script>
	<script src="source/Pastizal_1987.js"></script>
	<script src="source/Salinas_1987.js"></script>-->	
	<script src="source/Comarca_1987.js"></script>
	<script src="source/Comarca_2014.js"></script>
	<script src="source/Municipios.js"></script>
	<!--Capa 1987-->		
	<script src="source/Usos_suelo_1987.js"></script>
	<!--Capa 2014-->		
	<script src="source/Usos_suelo_2014.js"></script>
	
	<style>
		
		a{
			cursor: pointer;
		}
		
		.simple_view {			
			text-shadow:none;
			text-align:left;
			width:100%;
		}
		
		.left_map1987 {
			float: left;
			width:49%;
		}
	
		.right_map2014 {
			float: right;
			width:49%;
		}
		
		.mapa_sync{		
			height: 750px;
			text-shadow:none;
			text-align:left;
			/*box-shadow: 5px 5px 5px #888;*/
		}
		.leaflet-popup-content {
			margin: -5px 15px;
			color: grey;
			text-shadow: none;
		}
		.body{
			text-shadow: none !important;
		}
		.leaflet-control-mouseCoordinate.leaflet-control {
			width: 166px;
		}
		.invertir-color {
			-webkit-filter: invert(100%);
			filter: invert(100%);
			display: inline;
			float: left;
			margin-top: -21px;
			margin-right: 15px;
		}
		.nav{
			margin-top: -11px;
		}
		.masthead-brand {
			margin-top: -3px;
		}
	</style>
</head>

<body>
	<!-- Large modal -->
	<button id="info_modal" type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-lg">Large modal</button>
	<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title">Modal title</h4>
		  </div>
		  <div class="modal-body">
			<p>Prueba grafica webix.js</p>
			<div id="chartDiv" style="width:600px;height:250px;margin:20px"></div>
			<script>			
				var dataset = [
					{ id:1, sales:20, year:"02"},
					{ id:2, sales:55, year:"03"},
					{ id:3, sales:40, year:"04"},
					{ id:4, sales:78, year:"05"},
					{ id:5, sales:61, year:"06"},
					{ id:6, sales:35, year:"07"},
					{ id:7, sales:80, year:"08"},
					{ id:8, sales:50, year:"09"},
					{ id:9, sales:65, year:"10"},
					{ id:10, sales:59, year:"11"}
				];
				webix.ui({
					container:"chartDiv",
					view:"chart",
					type:"bar",
					value:"#sales#",
					label:"#sales#",
					radius:0,
					barWidth:40,
					tooltip:{
						template:"#sales#"
					},
					xAxis:{
						title:"Cobertura del suelo",
						template:"'#year#",
						lines: false
					},
					padding:{
						left:10,
						right:10,
						top:50
					},
					data: dataset
				});
			</script>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			<button type="button" class="btn btn-primary">Save changes</button>
		  </div>
		</div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
	
	
	<div class="site-wrapper">
	  <div class="site-wrapper-inner">
		<div class="cover-container">
		  <div class="masthead clearfix">
			<div class="inner">
				<img class="invertir-color" src="css/images/ujaen_oglogo.png" height="60" width="60"></img>
				<h3 class="masthead-brand">Usos del suelo en el Poniente Almeriense</h3>
			  <nav>
				<ul class="nav masthead-nav">
				  <li id="tab_home" class="active"><a onclick="views_type('home');">Home</a></li>				  
				  <li id="tab_1987"><a onclick="views_type('map1987');">Mapa 1987</a></li>
				  <li id="tab_2014"><a onclick="views_type('map2014');">Mapa 2014</a></li>
				  <li id="tab_doble"><a onclick="views_type('doble_view');">Mapa doble</a></li>
				  <li id="tab_sync"><a id="etiq_sync" onclick="sync_mapas(map1987.isSynced());">Sincronizar</a></li>
				</ul>
			  </nav>
			</div>
		  </div>
		  
			<div id= 'home'class="inner cover" style="display: none;">
				<h1 class="cover-heading">Cover your page.</h1>				
			</div>
			
			<div id= 'doble_view' class="inner cover">			
				<div id='map1987' class='mapa_sync left_map1987'></div>
				<div id='map2014' class='mapa_sync right_map2014'></div>
			</div>
			  
		  <div class="mastfoot">
			<div class="inner">
			  <p>Map Template for <a href="#">Project</a>, by <a href="https://github.com/virulilla">Elena Salido 2016</a></p>
			</div>
		  </div>
		</div>
	  </div>
	</div>

	<script src="./lib/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
	<script src="./lib/bootstrap.min.js"></script>	
	<script>
	$("#info_modal").hide();
	
	var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org"> OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="http://mapbox.com">Mapbox</a>',
		mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';

	//Añadimos mapa base como tileLayer
	var OSM1987 = L.tileLayer(mbUrl, { attribution: mbAttr, id: 'mapbox.light', maxZoom: 18 });
		OSM2014 = L.tileLayer(mbUrl, { attribution: mbAttr, id: 'mapbox.light', maxZoom: 18 });
		streets2014  = L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr, maxZoom: 18});
		streets1987  = L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr, maxZoom: 18});

	//Creo la capa en leaflet
	var layer_usos1987=new L.geoJson(Usos_suelo_1987,{style:style});
	var layer_usos2014=new L.geoJson(Usos_suelo_2014,{style:style});
	var layer_municipios1987=new L.geoJson(Municipios, {style:style_municipios, onEachFeature: PopupArea}),
		layer_municipios2014=new L.geoJson(Municipios, {style:style_municipios, onEachFeature: PopupArea});
	
	//Constructor mapa
	var map2014 = L.map('map2014', { center: [36.76,-2.67], zoom: 10, attributionControl: false, layers: [OSM2014,streets2014,layer_usos2014,layer_municipios2014] });
		map1987= L.map('map1987', { center: [36.76,-2.67], zoom: 10, attributionControl: false, layers: [OSM1987,streets1987,layer_usos1987,layer_municipios1987] });
	/*
	//Cargamos cada capa 2014
	var layer_comarca_2014 = new L.geoJson(Comarca_2014,{style: style_municipios}).addTo(map2014);
		layer_forestal_2014 = new L.geoJson(Arbolado_forestal_2014,{style: style}).addTo(map2014);		
		layer_forzados_2014 = new L.geoJson(Cultivos_forzados_2014,{style: style}).addTo(map2014);
		layer_nula_2014 = new L.geoJson(Escasa_nula_vegetacion_2014,{style: style}).addTo(map2014);
		layer_frutal_2014 = new L.geoJson(Frutal_2014,{ style: style}).addTo(map2014);
		layer_huerta_2014 = new L.geoJson(Huerta_2014,{ style: style}).addTo(map2014);
		layer_agua_2014 = new L.geoJson(Masas_agua_2014,{ style: style}).addTo(map2014);		
		layer_pastizal_2014 = new L.geoJson(Pastizal_2014,{ style: style}).addTo(map2014);		
		layer_salinas_2014 = new L.geoJson(Salinas_2014,{style: style}).addTo(map2014);	
				
	//Cargamos cada capa 1987
	var layer_comarca_1987 = new L.geoJson(Comarca_1987,{style: style_municipios}).addTo(map1987);
		layer_forestal_1987 = new L.geoJson(Arbolado_forestal_1987,{style: style}).addTo(map1987);		
		layer_forzados_1987 = new L.geoJson(Cultivos_forzados_1987,{style: style}).addTo(map1987);
		layer_nula_1987 = new L.geoJson(Escasa_nula_vegetacion_1987,{style: style}).addTo(map1987);
		layer_frutal_1987 = new L.geoJson(Frutal_1987,{ style: style}).addTo(map1987);
		layer_huerta_1987 = new L.geoJson(Huerta_1987,{ style: style}).addTo(map1987);
		layer_agua_1987 = new L.geoJson(Masas_agua_1987,{ style: style}).addTo(map1987);		
		layer_pastizal_1987 = new L.geoJson(Pastizal_1987,{ style: style}).addTo(map1987);		
		layer_salinas_1987 = new L.geoJson(Salinas_1987,{style: style}).addTo(map1987);			
	
	//Incorporación capas en el grupo de capas
	var overlays2014 = { 
		"Comarca":layer_comarca_2014,
		"Arbolado forestal":layer_forestal_2014,
		"Cultivos forzados":layer_forzados_2014,
		"Frutal":layer_frutal_2014,
		"Huerta":layer_huerta_2014,
		"Masas de agua":layer_agua_2014,		
		"Pastizal":layer_pastizal_2014,		
		"Salinas":layer_salinas_2014,
		"Vegetacion escasa": layer_nula_2014
	};
	
	var overlays1987 = {
		"Comarca":layer_comarca_1987,
		"Arbolado forestal":layer_forestal_1987,
		"Cultivos forzados":layer_forzados_1987,
		"Frutal":layer_frutal_1987,
		"Huerta":layer_huerta_1987,
		"Masas de agua":layer_agua_1987,		
		"Pastizal":layer_pastizal_1987,		
		"Salinas":layer_salinas_1987,
		"Vegetacion escasa": layer_nula_1987
	};*/
	//Geoprocesos con Turf.js----------------------------------------	
	// Initialise the FeatureGroup to store editable layers
	var drawnItems2014 = new L.FeatureGroup();
	map2014.addLayer(drawnItems2014);

	var drawnItems1987 = new L.FeatureGroup();
	map1987.addLayer(drawnItems1987);


	// Initialise the draw control and pass it the FeatureGroup of editable layers
	var drawControl1987 = new L.Control.Draw({
		draw: {
			position: 'topleft',
			polygon: {
				title: 'Draw a sexy polygon!',
				allowIntersection: false,
				drawError: {
					color: '#b00b00',
					timeout: 1000
				},
				shapeOptions: {
					color: '#bada55'
				},
				showArea: true
			},
			polyline: {
				metric: false
			},
			circle: {
				shapeOptions: {
					color: '#662d91'
				}
			}
		},
		edit: {
			featureGroup: drawnItems1987
		}
	});


	//Mapas base
	var basemap2014 = { "Grayscale": OSM2014, "Streets": streets2014 };
		basemap1987 = { "Grayscale": OSM1987, "Streets": streets1987 };
	
	//Control de capas
	L.control.layers(basemap2014).addTo(map2014);//falta meter las capas del uso del suelo para activar/desactivar
	L.control.layers(basemap1987).addTo(map1987);
	
	//Mapa de situación
	var osm1= L.tileLayer(mbUrl, { attribution: mbAttr, id: 'mapbox.light', minZoom: 5, maxZoom: 10 });	
		osm2= L.tileLayer(mbUrl, { attribution: mbAttr, id: 'mapbox.light', minZoom: 5, maxZoom: 10 });
	
	var miniMap1 = new L.Control.MiniMap(osm1, {
		toggleDisplay: true,
		minimized: true
	}).addTo(map1987);
	
	var miniMap2 = new L.Control.MiniMap(osm2, {
		toggleDisplay: true,
		minimized: true
	}).addTo(map2014);
	
	//Coordenadas del mouse
	L.control.mouseCoordinate({utm:true,gps:false,position:'bottomright'}).addTo(map1987);
	L.control.mouseCoordinate({utm:true,gps:false,position:'bottomright'}).addTo(map2014);
	
	
	//Escala distancia abajo izquierda
	L.control.scale().addTo(map2014);
	L.control.scale().addTo(map1987);
	
	//Icono para imprimir en .pdf
	L.easyPrint({elementsToHide: 'li'}).addTo(map2014);
	L.easyPrint({elementsToHide: 'li'}).addTo(map1987);
		
	//Sincronizar los mapas de 2014 y 1987 con leaflet.sync
	function sync_mapas(sem){
		if(sem == false){			
			console.log('LOG: starting sync map: ' + window.performance.now()/1000 + ' sec.');
			map2014.sync(map1987);
			map1987.sync(map2014);
			console.log('LOG: ending sync map: ' + window.performance.now()/1000 + ' sec.');
			document.getElementById("etiq_sync").innerHTML = "Desincronizar";
			
			$('#tab_sync').addClass('active');
			
		}else{
			map1987.unsync(map2014);
			map2014.unsync(map1987);
			document.getElementById("etiq_sync").innerHTML = "Sincronizar";
			
			$('#tab_sync').removeClass('active');
		}		
	}
	
	//Geoprocesos con Turf.js
	// Initialise the FeatureGroup to store editable layers
	var drawnItems1987 = new L.FeatureGroup();

	map1987.addLayer(drawnItems1987);
	
	// Initialise the draw control and pass it the FeatureGroup of editable layers	
	var drawControl1987 = new L.Control.Draw({
		draw: {
			position: 'topleft',
			polygon: {
				title: 'Draw a sexy polygon!',
				allowIntersection: false,
				drawError: {
					color: '#b00b00',
					timeout: 1000
				},
				shapeOptions: {
					color: '#bada55'
				},
				showArea: true
			},
			polyline: {
				metric: false
			},
			circle: {
				shapeOptions: {
					color: '#662d91'
				}
			}
		},
		edit: {
			featureGroup: drawnItems1987
		}
	});
	var drawControl2014 = new L.Control.Draw({
		draw: {
			position: 'topleft',
			polygon: {
				title: 'Draw a sexy polygon!',
				allowIntersection: false,
				drawError: {
					color: '#b00b00',
					timeout: 1000
				},
				shapeOptions: {
					color: '#bada55'
				},
				showArea: true
			},
			polyline: {
				metric: false
			},
			circle: {
				shapeOptions: {
					color: '#662d91'
				}
			}
		},
		edit: {
			featureGroup: drawnItems1987
		}
	});
	map1987.addControl(drawControl1987);
	map2014.addControl(drawControl2014);
	//Triggered when a new vector or marker has been created
	map1987.on('draw:created', function (e) {
		var type = e.layerType,//layerType es el tipo de objeto. En este caso puede ser: poligon, rectangulo, círculo o marker.
			layer = e.layer; //'e' es el objecto que dispara la función. En este caso es un poligono de Draw

		if (type === 'marker') {
			var point_aux=new turf.point([layer._latlng.lng,layer._latlng.lat]);			
			var within;
			var str_municipio='Fuera del ámbito';			
			
			for( i=0; i<9; i++ ){
				within = turf.inside(point_aux, Municipios.features[i]);				
				if (within){//Si within es true, entra
					str_municipio=Municipios.features[i].properties.MUNICIPIO;
				}
			}				
			for( i=0; i<Usos_suelo_1987.features.length; i++ ){
				within = turf.inside(point_aux, Usos_suelo_1987.features[i]);				
				if (within){//Si within es true, entra
					layer.bindPopup('Cobertura: '+ Usos_suelo_1987.features[i].properties.Usos_suelo+' <br>Coordenadas: ('+point_aux.geometry.coordinates[1]+','+point_aux.geometry.coordinates[0]+') <br>Municipio: '+str_municipio);
				}
			}			
		}else if (type === 'rectangle'||type === 'polygon'){
			
			var polygon_aux=new L.Polygon(layer._latlngs, layer.options ).toGeoJSON();//convertimos layer en un poligono para poder hacer turf.intersect
			var area = area_interseca_usos(Usos_suelo_1987,polygon_aux);
			$("#info_modal").click();
			console.log('La superficie de las areas es '+ area[0]+'m2, '+ area[1]+'m2, '+ area[2]+'m2, '+ area[3]+'m2, '+ area[4]+'m2, '+ area[5]+'m2, '+ area[6]+'m2, '+ area[7]+'m2');
		}else if (type==='circle'){
			var projection = L.CRS.EPSG4326;
			var polys=createGeodesicPolygon(layer._latlng,layer._mRadius,60, 0,projection);
			var coords = []; // store the geometry
			for (var i = 0; i < polys.length; i++) {
				var geometry = [
					parseFloat(polys[i].lat.toFixed(3)),
					parseFloat(polys[i].lng.toFixed(3))
				]; 
				coords.push(geometry);
			}
			var polyCircle = L.polygon(coords).toGeoJSON();
			console.log('El area del poligono resultante del circulo es: '+turf.area(polyCircle));
			var area = area_interseca_usos(Usos_suelo_1987,polyCircle);
			//Se crea pop up
			$("#info_modal").click();
		}else if (type==='polyline'){//En caso de que sea una polilinea se mide la distancia de ésta, no se hace interseccion con las capas			
			var dist_polyline=layer.measuredDistance();
			console.log('La distancia de la línea es '+dist_polyline);
			//Se crea popup
		}
		
		drawnItems1987.addLayer(layer);
	});
	
	map2014.on('draw:created', function (e) {
		var type = e.layerType,//layerType es el tipo de objeto. En este caso puede ser: poligon, rectangulo, círculo o marker.
			layer = e.layer; //'e' es el objecto que dispara la función. En este caso es un poligono de Draw

		if (type === 'marker') {
			var point_aux=new turf.point([layer._latlng.lng,layer._latlng.lat]);			
			var within;
			var str_municipio='Fuera del ámbito';			
			
			for( i=0; i<9; i++ ){
				within = turf.inside(point_aux, Municipios.features[i]);				
				if (within){//Si within es true, entra
					str_municipio=Municipios.features[i].properties.MUNICIPIO;
				}
			}				
			for( i=0; i<Usos_suelo_2014.features.length; i++ ){
				within = turf.inside(point_aux, Usos_suelo_2014.features[i]);				
				if (within){//Si within es true, entra
					layer.bindPopup('Cobertura: '+ Usos_suelo_2014.features[i].properties.Usos_suelo+' <br>Coordenadas: ('+point_aux.geometry.coordinates[1]+','+point_aux.geometry.coordinates[0]+') <br>Municipio: '+str_municipio);
				}
			}			
		}else if (type === 'rectangle'||type === 'polygon'){
			var polygon_aux=new L.Polygon(layer._latlngs, layer.options ).toGeoJSON();//convertimos layer en un poligono para poder hacer turf.intersect
			var area = area_interseca_usos(Usos_suelo_2014,polygon_aux);
			$("#info_modal").click();
			console.log('La superficie de las areas es '+ area[0]+'m2, '+ area[1]+'m2, '+ area[2]+'m2, '+ area[3]+'m2, '+ area[4]+'m2, '+ area[5]+'m2, '+ area[6]+'m2, '+ area[7]+'m2');
		}else if (type==='circle'){
			var projection = L.CRS.EPSG4326;
			var polys=createGeodesicPolygon(layer._latlng,layer._mRadius,60, 0,projection);
			var coords = []; // store the geometry
			for (var i = 0; i < polys.length; i++) {
				var geometry = [
					parseFloat(polys[i].lat.toFixed(3)),
					parseFloat(polys[i].lng.toFixed(3))
				]; 
				coords.push(geometry);
			}
			var polyCircle = L.polygon(coords).toGeoJSON();
			console.log('El area del poligono resultante del circulo es: '+turf.area(polyCircle));
			var area = area_interseca_usos(Usos_suelo_2014,polyCircle);
			//Se crea pop up
			$("#info_modal").click();
		}else if (type==='polyline'){//En caso de que sea una polilinea se mide la distancia de ésta, no se hace interseccion con las capas			
			var dist_polyline=layer.measuredDistance();
			console.log('La distancia de la línea es '+dist_polyline);
			//Se crea popup
		}
		
		drawnItems2014.addLayer(layer);
	});
		
	$(window).on("resize", function() {
		$("#map1987").height($(window).height() - $(".mastfoot").height() - $(".masthead").height());
		$("#map2014").height($(window).height() - $(".mastfoot").height() - $(".masthead").height());
		map1987.invalidateSize();
		map2014.invalidateSize();
	}).trigger("resize");
	//ÑAPONNN!
	views_type('home');
	</script>
</body>
	
</html>